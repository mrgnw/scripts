#!/usr/bin/env zsh

mkdir -p original
setopt localoptions nocaseglob

extensions=(${(f)"$(globs images -x heic heif)"})

find . -maxdepth 1 -type f \( \
    $(printf -- "-iname %s -o " "${extensions[@]}") \
    -false \) -print0 | \
    parallel -0 -j "$(sysctl -n hw.ncpu)" '
        original_file={}
        heic_file="${original_file%.*}.heic"
        heic "$original_file"

        # Preserve the original file dates on the new HEIC file
        if [[ -f "$heic_file" ]]; then
            touch -r "$original_file" "$heic_file"
        fi

        mv "$original_file" original/
    '
